<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Earthquake Safety and SOS App ‚Äî Fixed</title>
    <style>
        /* --- CSS STYLES (unchanged except small overlay improvements) --- */
        :root {
            --primary-red: #e74c3c; --alert-red: #c0392b; --sos-red: #ff0000;
            --text-dark: #2c3e50; --bg-light: #f4f6f7;
            --monitor-bg: #2c3e50; --monitor-alert-bg: #96281b;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: sans-serif; }
        body { background-color: var(--bg-light); color: var(--text-dark); height: 100vh; display: flex; flex-direction: column; overflow-x: hidden; }
        header { background: white; padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .monitor-panel { background: var(--monitor-bg); color: white; width: 90%; max-width: 400px; border-radius: 15px; padding: 20px; margin-bottom: 30px; box-shadow: 0 10px 20px rgba(44, 62, 80, 0.2); position: relative; overflow: hidden; transition: background 0.3s; }
        .monitor-panel.alert-active { background: var(--monitor-alert-bg); box-shadow: 0 0 25px rgba(231, 76, 60, 0.6); border: 2px solid #e74c3c; }
        .monitor-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; color: #bdc3c7; z-index: 2; position: relative; }
        .status-indicator { display: flex; align-items: center; gap: 8px; color: #2ecc71; font-weight: bold; }
        .monitor-panel.alert-active .status-indicator { color: #fff; text-shadow: 0 0 5px rgba(255, 255, 255, 0.5); }
        .status-dot { width: 10px; height: 10px; background-color: #2ecc71; border-radius: 50%; box-shadow: 0 0 10px #2ecc71; animation: blink 2s infinite; }
        .monitor-panel.alert-active .status-dot { background-color: #e74c3c; box-shadow: 0 0 15px #e74c3c; animation: blink 0.5s infinite; }
        .location-data { font-family: 'Courier New', monospace; font-size: 1.1rem; margin-bottom: 5px; position: relative; z-index: 2; }
        .location-sub { font-size: 0.8rem; color: #95a5a6; position: relative; z-index: 2; }
        .monitor-panel.alert-active .location-sub { color: #ffcccb; font-weight: bold; }
        .radar-sweep { position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: conic-gradient(from 0deg, transparent 0deg, rgba(46, 204, 113, 0.1) 60deg, transparent 60deg); animation: radar 4s linear infinite; border-radius: 50%; pointer-events: none; z-index: 1; }
        .monitor-panel.alert-active .radar-sweep { background: conic-gradient(from 0deg, transparent 0deg, rgba(231, 76, 60, 0.4) 60deg, transparent 60deg); animation: radar 2s linear infinite; }
        @keyframes radar { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        main { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        p.subtitle { margin-bottom: 30px; color: #7f8c8d; max-width: 400px; }
        .emergency-btn { background-color: var(--primary-red); color: white; border: none; border-radius: 50%; width: 180px; height: 180px; font-size: 1.2rem; font-weight: bold; text-transform: uppercase; cursor: pointer; box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); animation: pulse 2s infinite; transition: transform 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; }
        .emergency-btn:active { transform: scale(0.95); }
        @keyframes pulse { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 20px rgba(231, 76, 60, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(44, 62, 80, 0.95); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; backdrop-filter: blur(5px); }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-card { background: white; width: 90%; max-width: 400px; border-radius: 20px; padding: 30px 20px; text-align: center; transform: translateY(50px); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); max-height: 90vh; overflow-y: auto; }
        .modal-overlay.active .modal-card { transform: translateY(0); }
        .modal-header { border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; margin-bottom: 20px; }
        .modal-header h2 { color: var(--alert-red); font-size: 1.8rem; text-transform: uppercase; }
        .steps-container { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        .step { background: #fff0f0; padding: 15px; border-radius: 12px; display: flex; align-items: center; text-align: left; border-left: 5px solid var(--primary-red); }
        .step-icon { font-size: 2rem; margin-right: 15px; min-width: 50px; text-align: center; }
        .step-icon svg { width: 40px; height: 40px; fill: var(--primary-red); }
        .step-text h3 { font-size: 1.1rem; margin-bottom: 4px; }
        .step-text p { font-size: 0.9rem; color: #666; }
        .button-group { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .btn-safe { background: #2ecc71; color: white; border: none; padding: 15px; width: 100%; border-radius: 10px; font-size: 1rem; font-weight: bold; cursor: pointer; }
        .btn-stuck { background: var(--sos-red); color: white; border: none; padding: 15px; width: 100%; border-radius: 10px; font-size: 1rem; font-weight: bold; cursor: pointer; animation: sos-pulse 1s infinite; }
        @keyframes sos-pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); } 100% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); } }
        .location-box { background: #f8f9fa; border: 2px dashed #95a5a6; padding: 15px; margin: 15px 0; border-radius: 8px; word-break: break-all; }
        .coords-text { font-family: monospace; font-size: 1.2rem; font-weight: bold; color: var(--text-dark); margin-bottom: 10px; display: block; }
        .map-link { display: inline-block; text-decoration: none; color: #3498db; font-weight: bold; font-size: 0.9rem; }
        .small-note { font-size: 0.85rem; color: #777; margin-top: 8px; }
    </style>
</head>
<body>
    <main>
        <div class="monitor-panel alert-active" role="region" aria-live="polite" aria-label="Seismic alert monitor">
            <div class="radar-sweep" aria-hidden="true"></div>
            <div class="monitor-header">
                <span>SEISMIC ALERT</span>
                <div class="status-indicator" id="statusIndicator">
                    <div class="status-dot" aria-hidden="true"></div>
                    CRITICAL
                </div>
            </div>
            <div class="location-data" id="geoCoords">Fetching Data...</div>
            <div class="location-sub" id="geoStatus">‚ö†Ô∏è TREMOR DETECTED</div>
        </div>

        <p class="subtitle">Tap below if you feel shaking.</p>

        <button class="emergency-btn" id="triggerBtn" aria-haspopup="dialog" aria-controls="safetyModal">
            <svg viewBox="0 0 24 24" fill="white" style="width: 32px; height: 32px;">
                <path d="M12 2L1 21h22L12 2zm1 16h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
            </svg>
            Earthquake<br>Strikes
        </button>
    </main>

    <!-- Safety Modal (Drop, Cover, Hold on) -->
    <div class="modal-overlay" id="safetyModal" data-modal>
        <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="safetyTitle">
            <div class="modal-header"><h2 id="safetyTitle">Action Required</h2><p>Do this immediately</p></div>
            <div class="steps-container">
                <div class="step"><div class="step-icon"><svg viewBox="0 0 24 24"><path d="M4 15h16v2H4zm0 4h16v2H4zm8-17l-6 6h12l-6-6z"/></svg></div><div class="step-text"><h3>1. DROP</h3><p>Drop to your hands and knees.</p></div></div>
                <div class="step"><div class="step-icon"><svg viewBox="0 0 24 24"><path d="M12 3L2 12h3v8h6v-6h2v6h6v-8h3L12 3zm0 13h-2v-2h2v2z"/></svg></div><div class="step-text"><h3>2. COVER</h3><p>Cover head/neck. Get under a table.</p></div></div>
                <div class="step"><div class="step-icon"><svg viewBox="0 0 24 24"><path d="M18 9v4H6V9H4v6h16V9h-2zM4 15h16v2H4z"/></svg></div><div class="step-text"><h3>3. HOLD ON</h3><p>Stay until shaking stops.</p></div></div>
            </div>

            <div class="button-group">
                <button class="btn-safe" id="iAmSafeBtn">I am Safe</button>
                <button class="btn-stuck" id="notSafeBtn">üö® I AM STUCK / NEED HELP</button>
            </div>
        </div>
    </div>

    <!-- SOS Modal -->
    <div class="modal-overlay" id="sosModal" data-modal>
        <div class="modal-card" style="border: 3px solid red;" role="dialog" aria-modal="true" aria-labelledby="sosTitle">
            <div class="modal-header"><h2 id="sosTitle" style="color: red;">SOS SIGNAL</h2><p>Rescuers need your location</p></div>

            <p>Show this screen to rescuers or send these coordinates:</p>

            <div class="location-box">
                <span class="coords-text" id="sosCoords">Locating...</span>
                <a href="#" target="_blank" rel="noopener noreferrer" class="map-link" id="googleMapLink" aria-label="Open location in Google Maps" style="display:none;">Open in Google Maps</a>
                <div class="small-note" id="sosNote" style="display:none;"></div>
            </div>
            <p style="font-size: 0.9rem; color: #555; margin-bottom: 20px;">
                Keep making noise. Do not light matches.
            </p>

            <button class="btn-safe" style="background: #34495e;" id="closeSosBtn">Close</button>
        </div>
    </div>

    <!-- Aftershock Modal -->
    <div class="modal-overlay" id="aftershockModal" data-modal>
        <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="aftershockTitle">
            <div class="modal-header"><h2 id="aftershockTitle" style="color: #f39c12;">‚ö†Ô∏è Warning</h2><p>Stay Alert</p></div>
            <div style="padding: 10px 0 20px 0;">
                <p style="font-size: 1.1rem; line-height: 1.5; color: #2c3e50;">
                    <strong>Do not return to damaged buildings.</strong><br><br>
                    Aftershocks are expected. Stay in open areas.
                </p>
            </div>
            <button class="btn-safe" style="background: #f39c12;" id="finalCloseBtn">Understood</button>
        </div>
    </div>

    <script>
        // --- Elements and Variables ---
        const triggerBtn = document.getElementById('triggerBtn');
        const safetyModal = document.getElementById('safetyModal');
        const iAmSafeBtn = document.getElementById('iAmSafeBtn');
        const notSafeBtn = document.getElementById('notSafeBtn');
        const sosModal = document.getElementById('sosModal');
        const sosCoords = document.getElementById('sosCoords');
        const googleMapLink = document.getElementById('googleMapLink');
        const closeSosBtn = document.getElementById('closeSosBtn');
        const aftershockModal = document.getElementById('aftershockModal');
        const finalCloseBtn = document.getElementById('finalCloseBtn');
        const geoCoords = document.getElementById('geoCoords');
        const geoStatus = document.getElementById('geoStatus');
        const statusIndicator = document.getElementById('statusIndicator');
        const sosNote = document.getElementById('sosNote');

        // Use numeric values for latitude/longitude internally (or null)
        let currentLatitude = null;
        let currentLongitude = null;
        let accuracyRadius = null;
        let currentAddress = "Address Not Fetched";

        // ‚ö†Ô∏è 1. UPDATE THIS WITH YOUR FIREBASE/SUPABASE REALTIME ENDPOINT ‚ö†Ô∏è
        // This must be your unique URL ending in /sos_alerts.json (or the correct endpoint for your backend)
        // If you don't have a backend yet, set to null to avoid accidental network calls.
        const RESCUER_API_ENDPOINT = null; // e.g. "https://your-unique-firebase-app.firebaseio.com/sos_alerts.json"

        // --- Helper utilities ---
        function formatLatLon(lat, lon) {
            // lat/lon are numbers here
            const latFixed = (lat !== null && lat !== undefined) ? lat.toFixed(6) : '‚Äî';
            const lonFixed = (lon !== null && lon !== undefined) ? lon.toFixed(6) : '‚Äî';
            const latHem = lat >= 0 ? 'N' : 'S';
            const lonHem = lon >= 0 ? 'E' : 'W';
            return `${latFixed}¬∞ ${latHem}, ${lonFixed}¬∞ ${lonHem}`;
        }

        // --- Network helpers ---

        // Build a Google Maps URL (works on mobile & desktop)
        function buildGoogleMapsUrl(lat, lon) {
            return `https://www.google.com/maps?q=${encodeURIComponent(lat)},${encodeURIComponent(lon)}`;
        }

        // Function to get Street Address from OpenStreetMap (Nominatim)
        // Note: Setting custom User-Agent headers from a browser is restricted.
        // Nominatim policies recommend including an `email` parameter for identification.
        // Replace 'your-email@example.com' below with a real contact email or proxy this request via your server.
        async function fetchAddress(lat, lon) {
            if (lat === null || lon === null) return null;
            const safeLat = encodeURIComponent(lat);
            const safeLon = encodeURIComponent(lon);
            // Add email parameter per Nominatim policy. Replace with a legit email if possible.
            const emailParam = encodeURIComponent('your-email@example.com'); // <-- replace
            const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${safeLat}&lon=${safeLon}&accept-language=en&email=${emailParam}`;

            try {
                const response = await fetch(url, {
                    // Do not try to set the "User-Agent" header here ‚Äî browsers block it.
                    // If you need guaranteed address resolution, proxy the request through your server and set User-Agent there.
                    method: 'GET'
                });
                if (!response.ok) throw new Error('Nominatim response not ok');
                const data = await response.json();
                if (data && data.display_name) {
                    return data.display_name;
                }
                return null;
            } catch (err) {
                console.warn('Address fetch failed:', err);
                return null;
            }
        }

        // Function to send data to the external server (Firebase / Supabase / your backend)
        // If RESCUER_API_ENDPOINT is null, we won't attempt to POST and will show message instead.
        async function sendSOSSignal(lat, lon, address) {
            if (!RESCUER_API_ENDPOINT) {
                // don't attempt to POST if endpoint isn't configured
                console.info('RESCUER_API_ENDPOINT is not configured. Skipping POST.');
                sosNote.textContent = 'Backend NOT configured ‚Äî copy the location or use the Google Maps link.';
                sosNote.style.display = 'block';
                return { ok: false, reason: 'NO_ENDPOINT' };
            }

            const payload = {
                timestamp: new Date().toISOString(),
                latitude: Number(lat),
                longitude: Number(lon),
                map_link: buildGoogleMapsUrl(lat, lon),
                human_address: address || null,
                accuracy_m: accuracyRadius ? Math.round(accuracyRadius) : null,
                status: "CRITICAL_HELP_NEEDED"
            };

            try {
                const response = await fetch(RESCUER_API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    return { ok: true };
                } else {
                    const text = await response.text().catch(()=>null);
                    console.error('SOS server returned error', response.status, text);
                    return { ok: false, reason: 'SERVER_ERROR', status: response.status, text };
                }
            } catch (e) {
                console.error('Network error during SOS transmission.', e);
                return { ok: false, reason: 'NETWORK_ERROR', error: e };
            }
        }

        // Updates the SOS UI elements
        function updateSosUI() {
            if (currentLatitude !== null && currentLongitude !== null) {
                sosCoords.innerHTML = `<div style="font-size: 1.4rem; color: #c0392b;">${currentLatitude.toFixed(6)}, ${currentLongitude.toFixed(6)}</div>`;
                googleMapLink.href = buildGoogleMapsUrl(currentLatitude, currentLongitude);
                googleMapLink.textContent = `üìç Open Location (Accuracy: ${accuracyRadius ? Math.round(accuracyRadius) : '‚Äî'} m)`;
                googleMapLink.style.display = 'inline-block';
            } else {
                sosCoords.textContent = "Waiting for GPS Signal...";
                googleMapLink.style.display = 'none';
            }
        }

        // --- Event Handlers ---
        triggerBtn.addEventListener('click', () => {
            safetyModal.classList.add('active');
            // small vibrate feedback if available
            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
        });

        iAmSafeBtn.addEventListener('click', () => {
            safetyModal.classList.remove('active');
            setTimeout(() => { aftershockModal.classList.add('active'); }, 300);
        });

        notSafeBtn.addEventListener('click', async () => {
            safetyModal.classList.remove('active');
            sosModal.classList.add('active');
            updateSosUI();

            // Attempt to fetch address first (so backend receives human-readable address when possible)
            // If address fetch fails, we still send coordinates.
            let resolvedAddress = currentAddress;
            if (currentLatitude !== null && currentLongitude !== null) {
                // indicate "fetching..." in UI
                sosCoords.innerHTML = `<div style="font-size: 1.1rem; color:#666;">${currentLatitude.toFixed(6)}, ${currentLongitude.toFixed(6)}</div><div style="font-size:0.85rem;color:#666;margin-top:6px;">Fetching address...</div>`;
                const addr = await fetchAddress(currentLatitude, currentLongitude);
                if (addr) {
                    currentAddress = addr;
                    resolvedAddress = addr;
                    sosCoords.innerHTML = `
                        <div style="font-size: 1.4rem; color: #c0392b;">${currentLatitude.toFixed(6)}, ${currentLongitude.toFixed(6)}</div>
                        <div style="font-size: 0.9rem; margin-top: 5px; color: #333; border-top: 1px solid #ddd; padding-top: 5px;">
                            ${currentAddress}
                        </div>
                    `;
                } else {
                    // show coordinates and note
                    sosCoords.innerHTML = `<div style="font-size:1.2rem;color:#c0392b;">${currentLatitude.toFixed(6)}, ${currentLongitude.toFixed(6)}</div><div style="font-size:0.85rem;color:red;margin-top:6px;">Address unavailable</div>`;
                }

                // Now send the SOS signal (attempt)
                const sendResult = await sendSOSSignal(currentLatitude, currentLongitude, resolvedAddress);
                if (sendResult.ok) {
                    alert('‚úÖ SOS Signal Sent! Rescuers are notified.');
                    sosNote.style.display = 'none';
                } else {
                    // Show helpful UI note and don't spam with alerts
                    console.warn('SOS send result', sendResult);
                    sosNote.textContent = (sendResult.reason === 'NO_ENDPOINT') ? 'Backend not configured. Please share location manually.' : 'Failed to send SOS automatically. Use Google Maps link to share location.';
                    sosNote.style.display = 'block';
                    if (sendResult.reason === 'NETWORK_ERROR') {
                        alert('NETWORK FAILED! No signal. Please use the Google Maps link to share your location manually if possible.');
                    } else if (sendResult.reason === 'SERVER_ERROR') {
                        alert('Error sending SOS! Server rejected the request. Please try sharing location manually.');
                    }
                }
            } else {
                // No GPS yet
                sosCoords.textContent = "Waiting for GPS Signal...";
                sosNote.textContent = 'No GPS signal. Try moving to clearer sky or enable location permissions.';
                sosNote.style.display = 'block';
            }
        });

        closeSosBtn.addEventListener('click', () => { sosModal.classList.remove('active'); sosNote.style.display = 'none'; });
        finalCloseBtn.addEventListener('click', () => { aftershockModal.classList.remove('active'); });

        // --- Geolocation Initialization ---
        if ("geolocation" in navigator) {
            navigator.geolocation.watchPosition(
                (position) => {
                    // Store numeric lat/lon for internal use; display formatted values
                    currentLatitude = position.coords.latitude;
                    currentLongitude = position.coords.longitude;
                    accuracyRadius = position.coords.accuracy;

                    // Update monitoring panel UI (with hemisphere)
                    geoCoords.textContent = formatLatLon(currentLatitude, currentLongitude);
                    geoStatus.textContent = `Accuracy: within ${Math.round(accuracyRadius)} meters`;

                    // If a modal is open for SOS, update its map/link
                    updateSosUI();
                },
                (error) => {
                    // Error handler ‚Äî show helpful user message
                    console.warn('Geolocation error:', error);
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            geoCoords.textContent = "Location Permission Denied";
                            geoStatus.textContent = "Enable location permissions in browser settings.";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            geoCoords.textContent = "Position Unavailable";
                            geoStatus.textContent = "Try moving to an open area.";
                            break;
                        case error.TIMEOUT:
                            geoCoords.textContent = "Location Timeout";
                            geoStatus.textContent = "Try again or check device settings.";
                            break;
                        default:
                            geoCoords.textContent = "GPS Error";
                            geoStatus.textContent = "Try again later.";
                    }
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        } else {
            geoCoords.textContent = "No GPS Support";
            geoStatus.textContent = "Your device/browser does not support geolocation.";
        }

        // Close modals when clicking the overlay (works reliably)
        window.addEventListener('click', (e) => {
            // If clicked on any modal overlay (they have data-modal), close that overlay.
            // Using class check to avoid accidental closure when clicking modal card.
            const overlay = e.target.closest('.modal-overlay');
            if (overlay && overlay.hasAttribute('data-modal')) {
                overlay.classList.remove('active');
            }
        });

        // Accessibility: close modals with Esc
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
            }
        });

        // Make sure focus outlines are visible when navigating with keyboard
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Tab') document.body.classList.add('user-is-tabbing');
        });

        // Small UX: if user clicks trigger and safety modal opens, ensure it is visible
        // (already handled by CSS transitions)
    </script>
</body>
</html>
